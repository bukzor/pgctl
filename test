#!/bin/bash
set -eu
export TOP=$(dirname $(readlink -f $0))
export PROJECT=pgctl
export COVERAGE_PROCESS_START=$TOP/.coveragerc
export COVERAGE_DEBUG=callers,config,dataio,dataop,pid,plugin,sys,trace
export COVERAGE_DEBUG_FILE=$TOP/.coverage-debug
export EXECNET_DEBUG=True

combine() {
    date '+%F %T.%N'
    $TOP/tests/testing/wait_for_files.py "$TOP/.coverage.*" 3
    date '+%F %T.%N'
    unset COVERAGE_PROCESS_START
    coverage_bak="$TOP/coverage.bak.$(date "+%F_%T.%N")"
    mkdir $coverage_bak
    cp -ar $TOP/.coverage* $coverage_bak
    coverage combine --rcfile=$TOP/.coveragerc
    coverage html --rcfile=$TOP/.coveragerc
    coverage report --rcfile=$TOP/.coveragerc --fail-under 100
}
fail() {
    combine
    echo '[31;1mFAIL[m'
}
trap fail ERR

# the travis default umask is 002, but ubuntu's is 022
umask 022

set -x
# See: https://bitbucket.org/ned/coveragepy/issue/340/keyerror-subpy
if [ -n "$VIRTUAL_ENV" -a -d $VIRTUAL_ENV/local ]; then
    rm -rf $VIRTUAL_ENV/local
    find $VIRTUAL_ENV -name '*.pyc' -print0 | xargs -0r rm
    find $VIRTUAL_ENV -name '__pycache__' -print0 | xargs -0r rmdir
fi

# clean out any leftover coverage data
rm -f $TOP/.coverage.* $TOP/.coverage $COVERAGE_DEBUG_FILE
# we actually do want to get coverage for our test-infra scripts:

# See: http://nedbatchelder.com/code/coverage/subprocess.html
$TOP/tests/testing/install_coverage_pth.py

# default arguments
if [ -z "$*" ]; then
    NCPU=$(getconf _NPROCESSORS_CONF)
    n=$((NCPU < 5 ? NCPU * 2 : 10))
    set -- -n $n $TOP/tests $($TOP/tests/testing/get_modulefile.py $PROJECT)

    # don't measure coverage during linting
    COVERAGE_PROCESS_START= pre-commit run --all-files
else
    COVERAGE_PROCESS_START= pre-commit run --no-stash
fi
py.test "$@"
combine
